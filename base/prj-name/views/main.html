{% extends 'layout.html' %}
{% block content %}

<div class="timeline">
  {% if user %}
  <div>
    <form id="twit-form" action="/post" method="post" enctype="multipart/form-data">
      <div class="input-group">
        <textarea id="twit" name="content" maxlength="140"></textarea>
      </div>
      <div class="img-preview">
        <img id="img-preview" src="" style="display: none;" width="250" alt="미리보기">
        <input id="img-url" type="hidden" name="url">
      </div>
      <div style="text-align: right;">
        <label for="private_post" id="private_checkbox" onclick="onClickCheck()">
          비공개로 게시
          <input type="checkbox" name="input_check" value='0' id="input_check">
          <input type="hidden" name="input_check" value='1' id="input_check_hidden" />
        </label>
      </div>
      <div id="div-buttons">
        <label id="img-label" for="img">사진/영상 업로드</label>
        <input id="img" type="file" accept="image/*, video/*">
        <div class="map-address">
          <label id="map-label" for="map" onclick="appear('map-select')">장소</label>
          <input type="hidden" id="placeName" name="placeName" value="">
          <script>
            function appear(id) {
              var con = document.getElementById(id);
              if (con.style.display == 'none') {
                con.style.display = 'block';
              } else {
                con.style.display = 'none';
              }
            }
          </script>
          <iframe name="map-select" id="map-select" style="display:none;" src="./map" width="100%" height="400"
            scrolling="no"></iframe>
          <input id="placeMap" type="hidden" name="placeMap">
        </div>
        <button id="twit-btn" type="submit" class="btn">글 업로드</button>
      </div>



      <!-- <div>
        <label id="video-label" for="img">동영상 업로드</label>
        <input id="video" type="file" accept="video/*|">
        <button id="twit-btn" type="submit" class="btn">짹짹</button>
      </div> -->
    </form>
  </div>
  {% endif %}
  <div class="twits">
    <form id="hashtag-form" action="/hashtag" style="text-align: center;">
      <input type="text" name="hashtag" placeholder="태그 검색">
      <button class="btn">검색</button>
    </form>
    {% for twit in twits %}
    <!-- 비공개로 올리지 않은 게시글이면-->
    <!-- if twit.expose == 1 -->

    {% if twit.expose == 1 or followerIdList.includes(twit.User.id) or twit.User.id == user.id %}
    <div class="twit">
      <input type="hidden" value="{{twit.User.id}}" class="twit-user-id">
      <input type="hidden" value="{{twit.id}}" class="twit-id">
      <div class="twit-author">{{twit.User.nick}}</div>

      {% if user %}
      {% if not followerIdList.includes(twit.User.id) and twit.User.id !== user.id %}
      <button class="twit-follow">팔로우하기</button>
      {% elif followerIdList.includes(twit.User.id) and twit.User.id !== user.id %}
      <button class="twit-unfollow">언팔로우하기</button>
      {% endif %}
      {% endif %}
      <div class="twit-map">{{twit.map}}<br></div>

      {% if twit.img.split(".").pop()=='mp4' %}
      <div class="twit-img"><video src="{{twit.img}}" alt="비디오섬네일" controls autoplay loop muted></video></div>
      {% elif twit.img %}
      <div class="twit-img"><img src="{{twit.img}}" alt="섬네일"></div>
      {% endif %}

      {% if user%}
      {% if not LikedPost.includes(twit.id) and twit.id !== user.id %}
      <button class="like">
        <span class="span-like">좋아요</span>
        <img class="twit-heart" src="icons/empty_heart.png" width="15px" height="15px">
        {{PostlikeCount}}
      </button>
      {% else %}
      <button class="unlike">
        <span class="span-like">좋아요 취소</span>
        <img class="twit-heart" src="icons/heart.png" width="15px" height="15px">
        {{PostlikeCount}}
      </button>
      {% endif %}

      {% if twit.User.id == user.id%}
      <div class="post_button_area">
        <div>
          <form style="display: inline" action="/post/{{twit.id}}/update" method="get">
            <button>글 수정</button>
          </form>
          <button name="post_delete" onclick="postDeleteButton('{{twit.id}}')">글 삭제</button>
        </div>
      </div>
      {% endif %}

      {% endif %}
      <div class="twit-content">{{twit.content}}</div>
      <div class="twit-createdAt" name="twit-createdAt">{{twit.createdAt}}</div>

      <hr>

      <!-- 성권님 코드 -->
      <div class="twit-comment-submit">
        <form id="comment-form" action="comment/create" method="post">
          <textarea name="content" class="comment_content" placeholder="댓글을 입력해주세요."></textarea>
          <input type="hidden" name="currentUserId" value="{{user.id}}">
          <input type="hidden" name="postId" value="{{twit.id}}">
          <!-- <input type="submit" class="comment_btn" value="댓글 작성"> -->
          <input type="image" value="댓글 작성 변경" src="icons/upload.png" height="32" width="32">
        </form>
      </div>

      {% for aComment in twit.Comments %}
      <div class="twit-comment-content">
        <div>
          <div style="font-size:15px;">{{aComment.User.nick}}&nbsp;&nbsp;&nbsp;{{aComment.content}}</div>
          <div style="font-size:10px; float: right;">시간 : {{aComment.createdAt}}</div>
        </div>
        <!-- <span style="font-size:10px; float: right;">시간 : {{aComment.createdAt}}</span> -->


        {%if user %}
        {%if aComment.User.id == user.id%}
        <div class="comment_update_area hide">
          <form action="comment/update" method="post">
            <textarea name="comment_content" class="comment_content" placeholder="변경할 댓글을 입력해주세요."></textarea>
            <input type="hidden" name="id" value="{{aComment.id}}">
            <input type="image" value="댓글 변경" src="icons/edit.png" height="32" width="32">
            <!--comment_btn-->
          </form>
          <button class="comment_update_cancel" onclick="commentUpdateCancelButton(this);">댓글 수정
            취소</button>
          <button name="comment_delete" onclick="commentDeleteButton('{{aComment.id}}')">댓글 삭제</button>
        </div>
        <span>
          <button name="comment_update" id="comment_update" onclick="commentUpdateButton(this);">ㄴ댓글 수정</button>
        </span>
        {% endif %}
        {% endif %}
      </div>
      {% endfor %}


      <!-- {% if twit.User.id == user.id%}
      <div class="post_button_area">
        <div>
          <button name="post_update"><a href="/post/{{twit.id}}/update">글 수정</a></button>
          <button name="post_delete" onclick="postDeleteButton('{{twit.id}}')">글 삭제</button>
        </div>
      </div>
      {% endif %} -->
    </div>
    {% endif %}
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  if (document.getElementById('img')) {
    document.getElementById('img').addEventListener('change', function (e) {
      const formData = new FormData();
      console.log(this, this.files);
      formData.append('img', this.files[0]);
      axios.post('/post/img', formData)
        .then((res) => {
          document.getElementById('img-url').value = res.data.url;
          document.getElementById('img-preview').src = res.data.url;
          document.getElementById('img-preview').style.display = 'inline';
          document.getElementById('fulladdress').value = res.data.pname;
        })
        .catch((err) => {
          console.error(err);
        });
    });
  }

  function onClickCheck() {
    if (document.getElementById("input_check").checked) {
      document.getElementById("input_check_hidden").disabled = true;
    }
  }





  if (document.getElementById('map')) {
    document.getElementById('map').addEventListener('change', function (e) {
      const formData = new FormData();
      formData.append('map', this.files[0]);
      axios.post('/post/map', formData)
        .then((res) => {
          document.getElementById('map-address').src = res.data.url;
          document.getElementById('placeName').value = res.data.url;
        })
        .catch((err) => {
          console.error(err);
        });
    });
  }

  document.querySelectorAll('.twit-follow').forEach(function (tag) {
    tag.addEventListener('click', function () {
      const myId = document.querySelector('#my-id');
      if (myId) {
        const userId = tag.parentNode.querySelector('.twit-user-id').value;
        if (userId !== myId.value) {
          if (confirm('팔로잉하시겠습니까?')) {
            axios.post(`/user/${userId}/follow`)
              .then(() => {
                location.reload();
              })
              .catch((err) => {
                console.error(err);
              });
          }

        }
      }
    });
  });


  /* 김현님 코드 부분 */
  document.querySelectorAll('.twit-unfollow').forEach(function (tag) {
    tag.addEventListener('click', function () {
      const myId = document.querySelector('#my-id');
      if (myId) {
        const userId = tag.parentNode.querySelector('.twit-user-id').value;
        if (userId !== myId.value) {
          if (confirm('팔로잉을 취소하시겠습니까?')) {
            axios.post(`/user/${userId}/unfollow_twit`)
              .then(() => {
                location.reload();
              })
              .catch((err) => {
                console.error(err);
              });
          }
        }
      }
    });
  });

  document.querySelectorAll('.like').forEach(function (tag) {
    tag.addEventListener('click', function () {
      const myId = document.querySelector('#my-id');
      const postId = tag.parentNode.querySelector('.twit-id').value;
      if (myId) {


        axios.post(`/post/${postId}/like`)
          .then(() => {
            location.reload();
          })
          .catch((err) => {
            console.error(err);
          });
      }
    });
  });

  document.querySelectorAll('.unlike').forEach(function (tag) {
    tag.addEventListener('click', function () {
      const myId = document.querySelector('#my-id');
      const postId = tag.parentNode.querySelector('.twit-id').value;
      if (myId) {

        axios.delete(`/post/${postId}/unlike`)
          .then(() => {
            location.reload();
          })
          .catch((err) => {
            console.error(err);
          });
      }
    });
  });

  /* 김현님 코드 부분 */




  function commentUpdateButton(event) {
    var element = event.parentNode.previousElementSibling;
    element.classList.remove("hide");
    event.style.display = 'none';
  }

  function commentUpdateCancelButton(event) {
    var element = event.parentNode;
    element.classList.add("hide");
    document.getElementById("comment_update").style.display = 'block';

  }

  function postDeleteButton(id) {
    axios.post(`post/${id}/delete`)
      .then(() => {
        location.reload();
      })
      .catch((err) => {
        console.error(err);
      });
  }

  function commentDeleteButton(id) {
    axios.post(`comment/${id}/delete`)
      .then(() => {
        location.reload();
      })
      .catch((err) => {
        console.error(err);
      });
  }

  document.querySelectorAll('.twit-unfollow').forEach(function (tag) {
    tag.addEventListener('click', function () {
      const myId = document.querySelector('#my-id');
      if (myId) {
        const userId = tag.parentNode.querySelector('.twit-user-id').value;
        if (userId !== myId.value) {
          if (confirm('팔로잉을 취소하시겠습니까?')) {
            axios.post(`/user/${userId}/unfollow_twit`)
              .then(() => {
                location.reload();
              })
              .catch((err) => {
                console.error(err);
              });
          }
        }
      }
    });
  });
</script>
{% endblock %}